name: Build OpenWrt and Release

on:
  workflow_dispatch:
    inputs:
      openwrt_ref:
        description: 'OpenWrt branch/tag/commit (e.g. openwrt-23.05, v23.05.3, af42c3b2)'
        required: false
        default: 'master'
      config_path:
        description: 'Path to .config file (default: .config in repo root)'
        required: false
        default: '.config'
permissions:
  contents: write
env:
  OPENWRT_REPO: https://github.com/openwrt/openwrt.git
  
  CUSTOM_PACKAGES: https://github.com/harryzhaozy/luci-packages.git
  WORKDIR: openwrt
  CCACHE_DIR: ${{ github.workspace }}/.ccache
  DL_DIR: ${{ github.workspace }}/.dl
  CCACHE_SIZE: 2G
  DL_SIZE_LIMIT_MB: 500

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 360
    steps:
      # 0. é‡Šæ”¾ GitHub Runner ç©ºé—´ï¼ˆå¯é‡Šæ”¾ 15GB+ï¼‰
      - name: Free disk space
        run: |
          echo "=== Before cleaning ==="
          df -h
           sudo rm -rf /usr/share/dotnet \
                      /usr/local/lib/android \
                      /opt/ghc \
                      /opt/hostedtoolcache \
                      /usr/local/lib/node_modules \
                      /usr/local/share/boost \
                      /usr/share/swift \
                      /usr/local/lib/heroku \
                      /usr/local/lib/firefox
          sudo apt-get clean
          sudo rm -rf /var/lib/apt/lists/* /var/cache/apt/*
          echo "=== After cleaning ==="
          df -h

     
      

      - name: Checkout workflow repo
        uses: actions/checkout@v4

      # æ¢å¤ ccache ç¼“å­˜
      - name: Restore ccache cache
        uses: actions/cache@v4
        with:
          path: ${{ env.CCACHE_DIR }}
          key: ccache-${{ github.event.inputs.openwrt_ref }}-${{ runner.os }}
          restore-keys: |
            ccache-${{ github.event.inputs.openwrt_ref }}
            ccache-

      # æ¢å¤ dl ç¼“å­˜
      - name: Restore dl cache
        uses: actions/cache@v4
        with:
          path: ${{ env.DL_DIR }}
          key: dl-${{ github.event.inputs.openwrt_ref }}-${{ runner.os }}
          restore-keys: |
            dl-${{ github.event.inputs.openwrt_ref }}
            dl-

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential ccache ecj fastjar file g++ gawk \
            gcc git java-propose-classpath libelf-dev libncurses5-dev libncursesw5-dev \
            libssl-dev python3 python3-pip python3-setuptools rsync subversion \
            swig unzip wget zlib1g-dev

      - name: Get OpenWrt source
        run: |
          git clone $OPENWRT_REPO $WORKDIR
          cd $WORKDIR
          ref="${{ github.event.inputs.openwrt_ref }}"
          if git rev-parse --verify --quiet "$ref" >/dev/null; then
            git checkout "$ref"
          elif git ls-remote --exit-code --heads origin "$ref" >/dev/null 2>&1; then
            git checkout -B "$ref" origin/"$ref"
          elif git ls-remote --exit-code --tags origin "$ref" >/dev/null 2>&1; then
            git checkout "tags/$ref"
          fi

      - name: Add custom packages
        working-directory: ${{ env.WORKDIR }}/package
        run: git clone $CUSTOM_PACKAGES
      
    
      - name: Update and install feeds
        working-directory: ${{ env.WORKDIR }}
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a
      
      - name: Update Golang
        working-directory: ${{ env.WORKDIR }}
        run: |    
          rm -rf feeds/packages/lang/golang
          git clone https://github.com/sbwml/packages_lang_golang -b 25.x feeds/packages/lang/golang
            
      - name: Install passwall
        working-directory: ${{ env.WORKDIR }}
        run: |
          # ç§»é™¤ openwrt feeds è‡ªå¸¦çš„æ ¸å¿ƒåº“
            rm -rf feeds/packages/net/{xray-core,v2ray-geodata,sing-box,chinadns-ng,dns2socks,hysteria,ipt2socks,microsocks,naiveproxy,shadowsocks-libev,shadowsocks-rust,shadowsocksr-libev,simple-obfs,tcping,trojan-plus,tuic-client,v2ray-plugin,xray-plugin,geoview,shadow-tls}
            git clone https://github.com/xiaorouji/openwrt-passwall-packages package/passwall-packages

            # ç§»é™¤ openwrt feeds è¿‡æ—¶çš„luciç‰ˆæœ¬
            rm -rf feeds/luci/applications/luci-app-passwall
            git clone https://github.com/xiaorouji/openwrt-passwall package/passwall-luci
            
      - name: Copy Config
        working-directory: ${{ env.WORKDIR }}
        run: |
          cfg_path="${{ github.workspace }}/${{ github.event.inputs.config_path || '.config' }}"
          if [ -f "$cfg_path" ]; then
            cp "$cfg_path" .config
            make defconfig
          fi
      
      #- name: Enable dnsmasq-full, disable dnsmasq
      #  working-directory: ${{ env.WORKDIR }}
      #  run: |
         
      #    sed -i 's/CONFIG_PACKAGE_dnsmasq=y/# CONFIG_PACKAGE_dnsmasq is not set/' .config
      #    echo "CONFIG_PACKAGE_dnsmasq-full=y" >> .config
      #    make defconfig
          
      - name: Modify default settings
        working-directory: ${{ env.WORKDIR }}
        run: |
          sed -i 's/192.168.1.1/192.168.1.10/g' package/base-files/files/bin/config_generate
          sed -i 's/UTC/CST-8/g' package/base-files/files/bin/config_generate
          sed -i "/set system.@system\[0\].timezone='CST-8'/a\ \tset system.@system[-1].zonename='Asia/Shanghai'" \
            package/base-files/files/bin/config_generate

      - name: Patch rust bootstrap
        working-directory: ${{ env.WORKDIR }}
        run: |
          #RUST_MAKEFILE="feeds/packages/lang/rust/Makefile"
          #if [ -f "$RUST_MAKEFILE" ] && grep -q "llvm.download-ci-llvm = true" "$RUST_MAKEFILE"; then
          #  sed -i 's/llvm.download-ci-llvm = true/llvm.download-ci-llvm = "false"/' "$RUST_MAKEFILE" || true
          #  echo "[PATCH] å·²å°† llvm.download-ci-llvm ä¿®æ”¹ä¸º \"false\" âœ…"
          #else
          #  echo "[SKIP] æœªæ‰¾åˆ°éœ€è¦æ›¿æ¢çš„é¡¹ï¼Œè·³è¿‡è¡¥ä¸"
          #fi
          sed -i 's/--set=llvm\.download-ci-llvm=true/--set=llvm.download-ci-llvm=false/' feeds/packages/lang/rust/Makefile
          make defconfig                                                        

      # è®¾ç½®ç¼“å­˜ç›®å½• & æ§åˆ¶ç¼“å­˜å¤§å°
      - name: Set cache dirs
        working-directory: ${{ env.WORKDIR }}
        env:
          CCACHE_DIR: ${{ env.CCACHE_DIR }}
          DL_DIR: ${{ env.DL_DIR }}
        run: |
          cp -n feeds.conf.default feeds.conf
          echo "CONFIG_DEVEL=y" >> .config
          echo "CONFIG_CCACHE=y" >> .config
          mkdir -p "$CCACHE_DIR" "$DL_DIR"
          ccache -M ${CCACHE_SIZE}
          make defconfig

      # æ£€æµ‹ç£ç›˜ç©ºé—´
      - name: Check disk space before build
        run: |
          avail=$(df --output=avail -BG . | tail -1 | tr -d 'G')
          echo "Available space: ${avail}G"
          if [ "$avail" -lt 10 ]; then
            echo "Low space (<10G), cleaning caches..."
            rm -rf ${{ env.WORKDIR }}/build_dir/* \
                   ${{ env.WORKDIR }}/tmp/* \
                   ${{ env.WORKDIR }}/staging_dir/*
            find ${{ env.DL_DIR }} -type f -size +${DL_SIZE_LIMIT_MB}M -delete
            df -h
          fi
      
      - name: Download package sources
        working-directory: ${{ env.WORKDIR }}
        run: |
         make download -j$(nproc)
         find dl -size -1024c -exec rm -f {} \;
     
      - name: Delete old releases
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # åˆ—å‡ºæ‰€æœ‰ release å¹¶åˆ é™¤ï¼ˆä¿ç•™æœ€æ–° 1 ä¸ªï¼‰
          releases=$(gh release list --limit 100 --json name --jq '.[].name' | tail -n +2)
          for r in $releases; do
            echo "Deleting release: $r"
            gh release delete "$r" --yes
          done

      #- name: Build OpenWrt
      #  working-directory: ${{ env.WORKDIR }}
       
      #  run: |
           #make toolchain/install -j$(nproc) V=s
      #     make -j$(nproc) || make -j1 V=s
           
      #     #make package/feeds/packages/rust/compile -j$(nproc) V=s
      
      # åˆ†æ­¥éª¤ç¼–è¯‘ï¼Œé¿å…ä¸€æ¬¡æ€§å¡çˆ†ç£ç›˜
      - name: Build toolchain
        working-directory: ${{ env.WORKDIR }}
        run: make toolchain/install -j$(nproc) V=s
      - name: Cleanup after toolchain
        working-directory: ${{ env.WORKDIR }}
        run: |
          echo "æ¸…ç† toolchain ä¸´æ—¶æ–‡ä»¶..."
          rm -rf tmp/*
          rm -rf logs/*
          du -sh . || true

      - name: Build rust (separately, fail if error)
        working-directory: ${{ env.WORKDIR }}
        run: |
          echo "ğŸ¦€ å¼€å§‹ç¼–è¯‘ Rust..."
          if make package/feeds/packages/rust/compile -j$(nproc) V=s; then
            echo "âœ… Rust å¹¶è¡Œç¼–è¯‘æˆåŠŸ"
          else
            echo "âš ï¸ Rust å¹¶è¡Œç¼–è¯‘å¤±è´¥ï¼Œå°è¯•å•çº¿ç¨‹..."
            if make package/feeds/packages/rust/compile -j1 V=s; then
              echo "âœ… Rust å•çº¿ç¨‹ç¼–è¯‘æˆåŠŸ"
            else
              echo "âŒ Rust ç¼–è¯‘å¤±è´¥ï¼Œé€€å‡º workflow"
              exit 1
            fi
          fi
      - name: Cleanup after Rust
        working-directory: ${{ env.WORKDIR }}
        run: |
          echo "æ¸…ç† rust ç¼–è¯‘ä¸´æ—¶æ–‡ä»¶..."
          rm -rf tmp/*
          rm -rf logs/*
          rm -rf build_dir/target-*/rust-*/target   # åªæ¸…ç†ä¸­é—´äº§ç‰©ï¼Œä¿ç•™ç¼–è¯‘ç»“æœ
          du -sh . || true
          
      - name: Build firmware
        working-directory: ${{ env.WORKDIR }}
        #run: make -j$(nproc) || make -j1 V=s
        run: make -j$(nproc) IGNORE_ERRORS=m || make -j1 V=s
        
      # æ„å»ºåæ¸…ç†
      - name: Cleanup after build
        run: |
          echo "=== Cleaning build artifacts to save space ==="
          rm -rf ${{ env.WORKDIR }}/build_dir/* \
                 ${{ env.WORKDIR }}/staging_dir/* \
                 ${{ env.WORKDIR }}/tmp/*
          find ${{ env.DL_DIR }} -type f -size +${DL_SIZE_LIMIT_MB}M -delete
          ccache -c
          df -h

      - name: Save ccache cache
        uses: actions/cache@v4
        with:
          path: ${{ env.CCACHE_DIR }}
          key: ccache-${{ github.event.inputs.openwrt_ref }}-${{ runner.os }}

      - name: Save dl cache
        uses: actions/cache@v4
        with:
          path: ${{ env.DL_DIR }}
          key: dl-${{ github.event.inputs.openwrt_ref }}-${{ runner.os }}

      - name: Upload firmware to release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: openwrt-${{ github.event.inputs.openwrt_ref || 'master' }}
          name: "OpenWrt build ${{ github.event.inputs.openwrt_ref || 'master' }}"
          files: |
            ${{ env.WORKDIR }}/bin/targets/x86/64/openwrt-x86-64-generic-squashfs-combined-efi.img.gz
            ${{ env.WORKDIR }}/bin/targets/x86/64/openwrt-x86-64-generic-ext4-combined-efi.img.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

